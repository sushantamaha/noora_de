{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.0b2", "generated_at": "2025-11-25T03:36:23.104850Z", "invocation_id": "c4e7ef2f-2d0b-4235-b6f7-9a23135701ff", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-25T03:36:22.111785Z", "completed_at": "2025-11-25T03:36:22.120520Z"}, {"name": "execute", "started_at": "2025-11-25T03:36:22.120865Z", "completed_at": "2025-11-25T03:36:22.193203Z"}], "thread_id": "Thread-1", "execution_time": 0.0832984447479248, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.noora_whatsapp.stg_messages", "compiled": true, "compiled_code": "\n\nselect\n    id as message_id,\n    uuid as message_uuid,\n    message_type,\n    masked_addressees,           -- correct spelling\n    masked_author,\n    masked_from_addr as masked_sender,\n    direction,\n    source_type,\n    external_id,\n    external_timestamp,\n    is_deleted,\n    last_status,\n    last_status_timestamp,\n    content,\n    author_type,\n    rendered_content,\n    inserted_at,\n    updated_at\nfrom \"whatsapp_communication\".\"public\".\"messages\"", "relation_name": "\"whatsapp_communication\".\"public\".\"stg_messages\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-25T03:36:22.117031Z", "completed_at": "2025-11-25T03:36:22.127126Z"}, {"name": "execute", "started_at": "2025-11-25T03:36:22.133357Z", "completed_at": "2025-11-25T03:36:22.195284Z"}], "thread_id": "Thread-2", "execution_time": 0.08527159690856934, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.noora_whatsapp.stg_statuses", "compiled": true, "compiled_code": "-- models/staging/stg_statuses.sql\n\n\nselect\n    s.id as status_id,\n    s.uuid as status_uuid,\n    s.message_uuid,\n    s.message_id,\n    s.number_id,\n    s.status,\n    s.updated_at,\n    s.timestamp as status_timestamp,\n    s.inserted_at as status_inserted_at,\n    row_number() over (partition by s.message_uuid order by s.timestamp) as status_sequence\nfrom \"whatsapp_communication\".\"public\".\"statuses\" s\nwhere s.status is not null", "relation_name": "\"whatsapp_communication\".\"public\".\"stg_statuses\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-25T03:36:22.199664Z", "completed_at": "2025-11-25T03:36:22.203491Z"}, {"name": "execute", "started_at": "2025-11-25T03:36:22.203778Z", "completed_at": "2025-11-25T03:36:22.560878Z"}], "thread_id": "Thread-4", "execution_time": 0.3623623847961426, "adapter_response": {"_message": "SELECT 14747", "code": "SELECT", "rows_affected": 14747}, "message": "SELECT 14747", "failures": null, "unique_id": "model.noora_whatsapp.int_messages_with_status_history", "compiled": true, "compiled_code": "\n\nWITH unique_messages AS (\n    -- Deduplicate messages: take the most recent version based on inserted_at\n    SELECT *\n    FROM (\n        SELECT \n            *,\n            ROW_NUMBER() OVER(PARTITION BY message_id ORDER BY inserted_at DESC) as row_num\n        FROM \"whatsapp_communication\".\"public\".\"stg_messages\"\n    ) m\n    WHERE row_num = 1\n),\n\npivoted_statuses AS (\n    -- Flatten 1-to-many statuses into columns\n    SELECT \n        message_id,\n        -- Pivot statuses to timestamps\n        MAX(CASE WHEN status = 'sent' THEN status_timestamp END) as sent_at,\n        MAX(CASE WHEN status = 'delivered' THEN status_timestamp END) as delivered_at,\n        MAX(CASE WHEN status = 'read' THEN status_timestamp END) as read_at,\n        MAX(CASE WHEN status = 'failed' THEN status_timestamp END) as failed_at,\n        MAX(CASE WHEN status = 'deleted' THEN 1 ELSE 0 END) as is_deleted_status\n        \n        -- Ensure comma is present before this line\n        -- ARRAY_AGG(status_uuid) as status_uuids\n\nFROM \"whatsapp_communication\".\"public\".\"stg_statuses\"\nGROUP BY message_id\n)\n\nSELECT \n    m.message_uuid as uuid, -- Renaming back to generic uuid for the final table if desired\n    m.message_id as original_id,\n    m.content,\n    m.rendered_content,\n    m.message_type,\n    m.direction,\n    m.masked_addressees,\n    m.masked_sender, -- updated from masked_from_addr\n    m.inserted_at as message_created_at,\n    \n    -- Status timestamps\n    s.sent_at,\n    s.delivered_at,\n    s.read_at,\n    s.failed_at,\n    -- s.status_uuids,\n    \n    -- Derived metrics\n    \n        (\n        (\n        (\n        ((s.read_at)::date - (s.sent_at)::date)\n     * 24 + date_part('hour', (s.read_at)::timestamp) - date_part('hour', (s.sent_at)::timestamp))\n     * 60 + date_part('minute', (s.read_at)::timestamp) - date_part('minute', (s.sent_at)::timestamp))\n     * 60 + floor(date_part('second', (s.read_at)::timestamp)) - floor(date_part('second', (s.sent_at)::timestamp)))\n     as seconds_to_read,\n    \n    -- Final state\n    COALESCE(s.is_deleted_status, 0) as has_delete_log\n\nFROM unique_messages m\nLEFT JOIN pivoted_statuses s ON m.message_id = s.message_id", "relation_name": "\"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-25T03:36:22.567112Z", "completed_at": "2025-11-25T03:36:22.586991Z"}, {"name": "execute", "started_at": "2025-11-25T03:36:22.587472Z", "completed_at": "2025-11-25T03:36:22.950716Z"}], "thread_id": "Thread-1", "execution_time": 0.38620948791503906, "adapter_response": {"_message": "SELECT 14747", "code": "SELECT", "rows_affected": 14747}, "message": "SELECT 14747", "failures": null, "unique_id": "model.noora_whatsapp.dim_messages", "compiled": true, "compiled_code": "-- models/marts/core/dim_messages.sql\n\n\nselect * from \"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"", "relation_name": "\"whatsapp_communication\".\"public_marts\".\"dim_messages\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-25T03:36:22.569402Z", "completed_at": "2025-11-25T03:36:22.593191Z"}, {"name": "execute", "started_at": "2025-11-25T03:36:22.593833Z", "completed_at": "2025-11-25T03:36:23.086678Z"}], "thread_id": "Thread-2", "execution_time": 0.5208580493927002, "adapter_response": {"_message": "INSERT 0 0", "code": "INSERT", "rows_affected": 0}, "message": "INSERT 0 0", "failures": null, "unique_id": "model.noora_whatsapp.fct_data_quality_audits", "compiled": true, "compiled_code": "\n\n/*\n  AUDIT LOG MODEL\n  ---------------\n  This model consolidates all data quality checks into a single table.\n  It is incremental, meaning it preserves history of when errors were detected.\n*/\n\nWITH \n-- 1. DETECT DUPLICATES\ncheck_duplicates AS (\n    SELECT \n        message_uuid as related_uuid,\n        'Duplicate Record' as check_name,\n        'High' as severity,\n        'Identical message found within ' || EXTRACT(EPOCH FROM time_diff) || ' seconds' as issue_details\n    FROM (\n        SELECT \n            message_uuid,\n            inserted_at,\n            masked_sender,\n            content,\n            direction,\n            inserted_at - LAG(inserted_at) OVER (\n                PARTITION BY masked_sender, content, direction \n                ORDER BY inserted_at\n            ) as time_diff\n        FROM \"whatsapp_communication\".\"public\".\"stg_messages\" -- Using source to catch them before aggregation if possible, or fct if preferred.\n        WHERE content IS NOT NULL\n        \n        -- To prevent re-scanning the entire table on each run\n        AND inserted_at > (SELECT MAX(execution_at) FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\")\n        \n    ) sub\n    WHERE time_diff < INTERVAL '10 seconds'\n),\n\n-- 2. LOGICAL CONSISTENCY: READ BEFORE SENT\ncheck_read_logic AS (\n    SELECT \n        uuid as related_uuid,\n        'Logical Error' as check_name,\n        'Critical' as severity,\n        'Message read ' || EXTRACT(EPOCH FROM (sent_at - read_at)) || 's before it was sent' as issue_details\n    FROM \"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"\n    WHERE read_at < sent_at\n    \n    -- To prevent re-scanning the entire table on each run\n    AND message_created_at > (SELECT MAX(execution_at) FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\")\n    \n),\n\n-- 3. LOGICAL CONSISTENCY: DELIVERED BEFORE SENT\ncheck_delivered_logic AS (\n    SELECT \n        uuid as related_uuid,\n        'Logical Error' as check_name,\n        'Critical' as severity,\n        'Message delivered ' || EXTRACT(EPOCH FROM (sent_at - delivered_at)) || 's before it was sent' as issue_details\n    FROM \"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"\n    WHERE delivered_at < sent_at\n    \n    -- To prevent re-scanning the entire table on each run\n    AND message_created_at > (SELECT MAX(execution_at) FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\")\n    \n),\n\n-- 4. MISSING CRITICAL INFO\ncheck_completeness AS (\n    SELECT \n        uuid as related_uuid,\n        'Missing Data' as check_name,\n        'High' as severity,\n        CASE \n            WHEN direction = 'outbound' AND (masked_addressees IS NULL OR masked_addressees = '') THEN 'Outbound message missing addressee'\n            WHEN direction = 'inbound' AND (masked_sender IS NULL OR masked_sender = '') THEN 'Inbound message missing sender'\n            ELSE 'Missing critical routing info'\n        END as issue_details\n    FROM \"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"\n    WHERE \n        (direction = 'outbound' AND (masked_addressees IS NULL OR masked_addressees = ''))\n        OR (direction = 'inbound' AND (masked_sender IS NULL OR masked_sender = ''))\n    \n    -- To prevent re-scanning the entire table on each run\n    AND message_created_at > (SELECT MAX(execution_at) FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\")\n    \n),\n\n-- 5. INVALID ROUTING INFO\ncheck_invalid_routing AS (\n    SELECT \n        uuid as related_uuid,\n        'Invalid Data' as check_name,\n        'High' as severity,\n        CASE \n            WHEN direction = 'outbound' AND masked_addressees = '' THEN 'Outbound message with empty addressee'\n            WHEN direction = 'inbound' AND masked_sender = '' THEN 'Inbound message with empty sender'\n            ELSE 'Invalid critical routing info'\n        END as issue_details\n    FROM \"whatsapp_communication\".\"public\".\"int_messages_with_status_history\"\n    WHERE \n        (direction = 'outbound' AND masked_addressees = '')\n        OR (direction = 'inbound' AND masked_sender = '')\n    \n    -- To prevent re-scanning the entire table on each run\n    AND message_created_at > (SELECT MAX(execution_at) FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\")\n    \n),\n\n-- UNION ALL CHECKS\nall_issues AS (\n    SELECT * FROM check_duplicates\n    UNION ALL\n    SELECT * FROM check_read_logic\n    UNION ALL\n    SELECT * FROM check_delivered_logic\n    UNION ALL\n    SELECT * FROM check_completeness\n    UNION ALL\n    SELECT * FROM check_invalid_routing\n)\n\nSELECT\n    -- Generate a unique ID for this specific audit record\n    \n    \nmd5(cast(coalesce(cast(related_uuid as TEXT), '_dbt_utils_surrogate_key_null_') || '-' || coalesce(cast(check_name as TEXT), '_dbt_utils_surrogate_key_null_') as TEXT)) as audit_id,\n    CURRENT_TIMESTAMP as execution_at,\n    related_uuid,\n    check_name,\n    severity,\n    issue_details\nFROM all_issues\n\n\n  -- This condition prevents re-inserting the same errors on subsequent runs\n  WHERE related_uuid NOT IN (SELECT related_uuid FROM \"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\" WHERE check_name = all_issues.check_name)\n", "relation_name": "\"whatsapp_communication\".\"public_marts\".\"fct_data_quality_audits\"", "batch_results": null}], "elapsed_time": 1.1693918704986572, "args": {"state_modified_compare_more_unrendered_values": false, "export_saved_queries": false, "vars": {}, "write_json": true, "invocation_command": "dbt build --profiles-dir . --project-dir .", "include_saved_query": false, "require_explicit_package_overrides_for_builtin_materializations": true, "exclude_resource_types": [], "log_format": "default", "which": "build", "log_format_file": "debug", "exclude": [], "macro_debugging": false, "send_anonymous_usage_stats": true, "log_level": "info", "require_resource_names_without_spaces": false, "print": true, "quiet": false, "indirect_selection": "eager", "state_modified_compare_vars": false, "version_check": true, "favor_state": false, "resource_types": [], "log_path": "logs", "partial_parse_file_diff": true, "populate_cache": true, "log_level_file": "debug", "skip_nodes_if_on_run_start_fails": false, "strict_mode": false, "defer": false, "project_dir": ".", "static_parser": true, "cache_selected_only": false, "source_freshness_run_project_hooks": false, "use_colors": true, "log_file_max_bytes": 10485760, "introspect": true, "select": [], "use_colors_file": true, "warn_error_options": {"include": [], "exclude": []}, "partial_parse": true, "profiles_dir": ".", "printer_width": 80, "show_resource_report": false, "empty": false, "show": false}}